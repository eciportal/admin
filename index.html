<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaching Institute Admin Panel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for Dashboard Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* View switching animation */
        .view { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Active navigation link style */
        .nav-link.active { background-color: #4f46e5; color: white; }
        
        /* Hide main panel during initial load */
        #admin-panel { display: none; }

        /* Mobile-first sidebar styles */
        #sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen bg-slate-200">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div class="text-center">
                <i class="fas fa-user-shield fa-3x text-indigo-600"></i>
                <h2 class="mt-4 text-3xl font-bold text-gray-900">Admin Login</h2>
                <p class="mt-2 text-sm text-gray-600">Please sign in to access the dashboard.</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Email address</label>
                    <input id="email" name="email" type="email" autocomplete="email" required value="admin@example.com" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" required value="password123" class="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Sign in
                </button>
            </form>
            <div id="login-error" class="text-center text-sm text-red-600"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="relative min-h-screen md:flex">
        <!-- Mobile menu button -->
        <div class="absolute top-0 right-0 p-4 md:hidden">
            <button id="mobile-menu-button" class="text-slate-500 hover:text-slate-600 focus:outline-none">
                <i class="fas fa-bars fa-2x"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-800 text-slate-100 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 z-30">
            <div class="flex items-center justify-between px-4">
                <a href="#" class="text-white flex items-center space-x-2">
                    <i class="fas fa-school fa-2x text-indigo-400"></i>
                    <span class="text-2xl font-extrabold">Admin Panel</span>
                </a>
                <button id="close-sidebar-button" class="md:hidden text-slate-400 hover:text-white">
                    <i class="fas fa-times fa-2x"></i>
                </button>
            </div>
            <nav>
                <a href="#dashboard" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-slate-700" data-view="dashboard-view">
                    <i class="fas fa-tachometer-alt w-6 mr-3"></i> Dashboard
                </a>
                <a href="#manage-students" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-slate-700" data-view="manage-students-view">
                    <i class="fas fa-users-cog w-6 mr-3"></i> Students
                </a>
                <a href="#add-student" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-slate-700" data-view="add-student-view">
                    <i class="fas fa-user-plus w-6 mr-3"></i> Add Student
                </a>
                <a href="#attendance" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-slate-700" data-view="attendance-view">
                    <i class="fas fa-calendar-check w-6 mr-3"></i> Attendance
                </a>
            </nav>
            <div class="absolute bottom-0 w-full left-0 px-2 pb-4">
                 <button id="logout-btn" class="w-full flex items-center justify-center px-4 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200">
                    <i class="fas fa-sign-out-alt w-6 mr-3"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-10">
            <!-- All Views will be injected here -->
            <div id="dashboard-view" class="view"></div>
            <div id="manage-students-view" class="view"></div>
            <div id="add-student-view" class="view"></div>
            <div id="attendance-view" class="view"></div>
        </main>
    </div>

    <!-- All Modals -->
    <div id="edit-student-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"></div>
    <div id="fee-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"></div>
    <div id="generic-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50"></div>

    <!-- Templates for Views and Modals -->
    <template id="template-dashboard-view">
        <h1 class="text-3xl font-bold text-slate-800 mb-6">Dashboard</h1>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="fas fa-users fa-2x"></i></div><div class="ml-4"><p class="text-lg text-slate-500">Total Students</p><p id="total-students-stat" class="text-3xl font-bold text-slate-800">0</p></div></div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center"><div class="bg-green-100 text-green-600 p-4 rounded-full"><i class="fas fa-dollar-sign fa-2x"></i></div><div class="ml-4"><p class="text-lg text-slate-500">Fees This Month</p><p id="fees-stat" class="text-3xl font-bold text-slate-800">â‚¹0</p></div></div>
            <div class="bg-white p-6 rounded-xl shadow-md sm:col-span-2 lg:col-span-4">
                <h3 class="font-semibold text-slate-800 mb-2">Students by Class</h3>
                <canvas id="students-by-class-chart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md sm:col-span-2 lg:col-span-4">
                <h3 class="font-semibold text-slate-800 mb-2">Recent Registrations</h3>
                <div id="recent-registrations-list" class="space-y-2"><p class="text-slate-500">Loading...</p></div>
            </div>
        </div>
    </template>

    <template id="template-manage-students-view">
        <h1 class="text-3xl font-bold text-slate-800 mb-6">Manage Students</h1>
        <div class="bg-white p-6 rounded-xl shadow-md">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <input type="text" id="search-student" placeholder="Search..." class="w-full sm:w-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="export-csv-btn" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><i class="fas fa-file-csv mr-2"></i>Export to CSV</button>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Student ID</th><th class="px-6 py-3">Name</th><th class="px-6 py-3">Mobile</th><th class="px-6 py-3 text-center">Actions</th></tr></thead><tbody id="students-table-body"></tbody></table></div>
        </div>
    </template>
    
    <template id="template-add-student-view">
         <h1 class="text-3xl font-bold text-slate-800 mb-6">Add New Student</h1>
        <div class="bg-white p-6 rounded-xl shadow-md max-w-2xl mx-auto"><form id="add-student-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="name" class="block text-sm font-medium">Full Name</label><input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="fatherName" class="block text-sm font-medium">Father's Name</label><input type="text" id="fatherName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="mobile" class="block text-sm font-medium">Mobile Number <span class="text-red-500">*</span></label><input type="tel" id="mobile" required pattern="[0-9]{10}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div><div><label for="course" class="block text-sm font-medium">Class/Course</label><select id="course" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="6">6th</option><option value="7">7th</option><option value="8">8th</option><option value="9">9th</option><option value="10">10th</option><option value="11">11th</option><option value="12">12th</option></select></div></div><div class="text-right"><button type="submit" class="inline-flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Add Student</button></div><div id="add-student-feedback" class="text-center text-sm mt-4"></div></form></div>
    </template>

    <template id="template-attendance-view">
        <h1 class="text-3xl font-bold text-slate-800 mb-6">Mark Attendance</h1>
        <div class="bg-white p-6 rounded-xl shadow-md"><div class="flex flex-col sm:flex-row gap-4 items-center mb-4"><div><label for="attendance-course" class="block text-sm font-medium">Select Class</label><select id="attendance-course" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option value="6">6th</option><option value="7">7th</option><option value="8">8th</option><option value="9">9th</option><option value="10">10th</option><option value="11">11th</option><option value="12">12th</option></select></div><div><label for="attendance-date" class="block text-sm font-medium">Select Date</label><input type="date" id="attendance-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div></div><div id="attendance-student-list" class="overflow-x-auto"><p class="text-slate-500 text-center p-4">Please select a class and date.</p></div></div>
    </template>
    
    <!-- Modal Templates -->
    <template id="template-edit-student-modal"></template>
    <template id="template-fee-modal"></template>
    <template id="template-generic-modal"></template>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, getCountFromServer, addDoc, doc, updateDoc, deleteDoc, query, where, serverTimestamp, onSnapshot, orderBy, limit, setDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWkPt4hWE5hSx5XOZDo_0clnEzYnJMTnI",
            authDomain: "studentid-3132e.firebaseapp.com",
            projectId: "studentid-3132e",
            storageBucket: "studentid-3132e.appspot.com",
            messagingSenderId: "358629211169",
            appId: "1:358629211169:web:4ee8912293caabb312f760"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const studentsRef = collection(db, "students");

        // --- Global State ---
        let allStudents = [];
        let studentsByClassChart = null;
        let unsubscribeListeners = [];
        const monthNames = ["", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- UI Setup & Event Listeners ---
        const setupUI = () => {
            const views = ['dashboard', 'manage-students', 'add-student', 'attendance'];
            views.forEach(view => {
                const template = document.getElementById(`template-${view}-view`);
                if (template) {
                    document.getElementById(`${view}-view`).innerHTML = template.innerHTML;
                }
            });

            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
            });
            document.getElementById('close-sidebar-button').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('open');
            });
        };
        setupUI();

        // --- Modal System ---
        const showModal = (modalId, content) => {
            const modal = document.getElementById(modalId);
            if (content) modal.innerHTML = content;
            modal.style.display = 'block';
        };
        const closeModal = (modalId) => { document.getElementById(modalId).style.display = 'none'; };
        const showGenericModal = (title, text, iconHtml, buttons) => {
             const content = `<div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">${iconHtml}</div><h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">${title}</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500">${text}</p></div><div class="items-center px-4 py-3">${buttons.map(b => `<button class="${b.classes}" onclick="${b.onClick}">${b.text}</button>`).join('')}</div></div></div>`;
            showModal('generic-modal', content);
        };
        const showErrorModal = (message) => showGenericModal('Error', message, '<i class="fas fa-times fa-2x text-red-600"></i>', [{ text: 'Close', classes: 'px-4 py-2 bg-gray-200 rounded-md', onClick: "window.app.closeModal('generic-modal')" }]);
        const showConfirmationModal = (title, text, onConfirm) => showGenericModal(title, text, '<i class="fas fa-exclamation-triangle fa-2x text-yellow-500"></i>', [{ text: 'Confirm', classes: 'px-4 py-2 bg-red-600 text-white rounded-md mr-2', onClick: `${onConfirm}; window.app.closeModal('generic-modal')` }, { text: 'Cancel', classes: 'px-4 py-2 bg-gray-200 rounded-md', onClick: "window.app.closeModal('generic-modal')" }]);

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            const loginView = document.getElementById('login-view');
            const adminPanel = document.getElementById('admin-panel');
            if (user) {
                loginView.style.display = 'none';
                adminPanel.style.display = 'flex';
                navigateTo('dashboard-view');
            } else {
                loginView.style.display = 'flex';
                adminPanel.style.display = 'none';
                unsubscribeListeners.forEach(unsub => unsub());
                unsubscribeListeners = [];
            }
        });
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target.email.value, password = e.target.password.value;
            try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { document.getElementById('login-error').textContent = 'Invalid credentials.'; }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- Navigation ---
        const navigateTo = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.nav-link').forEach(link => link.classList.toggle('active', link.dataset.view === viewId));
            
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            
            const template = document.getElementById(`template-${viewId}`);
            if (template) {
                document.getElementById(viewId).innerHTML = template.innerHTML;
            }

            switch (viewId) {
                case 'dashboard-view': fetchDashboardData(); break;
                case 'manage-students-view': listenForStudents(); break;
                case 'add-student-view': break;
                case 'attendance-view': listenForStudents(); document.getElementById('attendance-date').valueAsDate = new Date(); break;
            }
        };
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(e.currentTarget.dataset.view);
                document.getElementById('sidebar').classList.remove('open'); // Close sidebar on mobile nav
            });
        });

        // --- Dashboard ---
        const fetchDashboardData = async () => {
            listenForStudents(); // Dashboard needs student data for charts and recent registrations
            
            const regQuery = query(studentsRef, orderBy("createdAt", "desc"), limit(5));
            const regSnapshot = await getDocs(regQuery);
            const listEl = document.getElementById('recent-registrations-list');
            listEl.innerHTML = regSnapshot.docs.map(doc => {
                const student = doc.data();
                const date = student.createdAt?.toDate().toLocaleDateString() || 'N/A';
                return `<div class="flex justify-between items-center text-sm p-2 rounded hover:bg-slate-50"><span>${student.name || 'Unnamed Student'} (${student.studentId})</span><span class="text-slate-500">${date}</span></div>`;
            }).join('');
            
            updateDashboardFeeStat();
        };

        const updateDashboardFeeStat = async () => {
            const allStudentsSnapshot = await getDocs(studentsRef);
            let totalFees = 0;
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const feePromises = [];
            allStudentsSnapshot.forEach(studentDoc => {
                const feesRef = collection(db, "students", studentDoc.id, "fees");
                feePromises.push(getDocs(feesRef));
            });

            try {
                const feeQuerySnapshots = await Promise.all(feePromises);
                feeQuerySnapshots.forEach(feeQuerySnapshot => {
                    feeQuerySnapshot.forEach(feeDoc => {
                        const feeData = feeDoc.data();
                        if (feeData.paymentDate && feeData.paymentDate.toDate) {
                            const paymentDate = feeData.paymentDate.toDate();
                            if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                                totalFees += feeData.amountPaid;
                            }
                        }
                    });
                });
                document.getElementById('fees-stat').textContent = `â‚¹${totalFees.toLocaleString('en-IN')}`;
            } catch (error) {
                console.error("Error calculating monthly fees:", error);
                document.getElementById('fees-stat').textContent = 'Error';
            }
        };

        const updateDashboardChart = () => {
            const chartCanvas = document.getElementById('students-by-class-chart');
            if (!allStudents.length || !chartCanvas) return; // FIX: Guard clause
            const classCounts = allStudents.reduce((acc, s) => { acc[s.course] = (acc[s.course] || 0) + 1; return acc; }, {});
            const labels = Object.keys(classCounts).sort((a,b) => a-b).map(c => `Class ${c}`);
            const data = Object.keys(classCounts).sort((a,b) => a-b).map(c => classCounts[c]);
            const ctx = chartCanvas.getContext('2d');
            if (window.studentsByClassChart) window.studentsByClassChart.destroy();
            window.studentsByClassChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '# of Students', data, backgroundColor: 'rgba(79, 70, 229, 0.8)' }] }, options: { scales: { y: { beginAtZero: true } } } });
        };

        // --- Event Delegation for Dynamic Content ---
        document.addEventListener('submit', (e) => {
            if (e.target.id === 'add-student-form') handleAddStudent(e);
            if (e.target.id === 'add-fee-form') handleAddFee(e);
            if (e.target.id === 'edit-student-form') handleUpdateStudent(e); // FIX: Added handler
        });
        document.addEventListener('input', (e) => {
            if (e.target.id === 'search-student') renderStudentsTable(allStudents.filter(s => (s.name || '').toLowerCase().includes(e.target.value.toLowerCase())));
            if (e.target.matches('#attendance-course, #attendance-date')) loadAttendanceList();
        });

        const addListener = (unsub) => unsubscribeListeners.push(unsub);
        
        const listenForStudents = () => addListener(onSnapshot(query(studentsRef, orderBy("createdAt", "desc")), (snapshot) => {
            allStudents = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
            renderStudentsTable(allStudents);
            if(document.getElementById('dashboard-view').style.display === 'block') {
                document.getElementById('total-students-stat').textContent = allStudents.length;
                updateDashboardChart();
            }
        }));

        // --- Render Functions ---
        const renderStudentsTable = (students) => {
            const tableBody = document.getElementById('students-table-body');
            if(!tableBody) return;
            tableBody.innerHTML = students.map(s => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${s.studentId || 'N/A'}</td>
                    <td class="px-6 py-4">${s.name || ''}</td>
                    <td class="px-6 py-4">${s.mobile}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="window.app.openFeeManager('${s.docId}')" title="Fees" class="font-medium text-blue-600 hover:underline mr-3"><i class="fas fa-dollar-sign"></i></button>
                        <button onclick="window.app.populateEditForm('${s.docId}')" title="Edit" class="font-medium text-indigo-600 hover:underline mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="window.app.deleteStudent('${s.docId}')" title="Delete" class="font-medium text-red-600 hover:underline"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        };

        // --- Handler Functions ---
        const handleAddStudent = async (e) => {
            e.preventDefault();
            const form = e.target;
            const student = { name: form.name.value.trim(), fatherName: form.fatherName.value.trim(), mobile: form.mobile.value.trim(), course: form.course.value, secretCode: '224205', createdAt: serverTimestamp() };
            try {
                if (!(await getDocs(query(studentsRef, where("mobile", "==", student.mobile)))).empty) throw new Error(`Mobile number ${student.mobile} is already registered.`);
                const countSnapshot = await getCountFromServer(query(studentsRef, where("course", "==", student.course)));
                student.studentId = `S${String(student.course).padStart(2, '0')}${String(countSnapshot.data().count + 1).padStart(3, '0')}`;
                await addDoc(studentsRef, student);
                form.reset();
                document.getElementById('add-student-feedback').textContent = `Student added successfully with ID ${student.studentId}!`;
            } catch (error) { document.getElementById('add-student-feedback').textContent = error.message; }
        };

        const handleAddFee = async (e) => {
            e.preventDefault();
            const form = e.target;
            const docId = form['fee-student-doc-id'].value;
            const feeData = { amountPaid: Number(form['fee-amount'].value), paymentMethod: form['fee-method'].value, feeMonth: Number(form['fee-month'].value), feeYear: Number(form['fee-year'].value), paymentDate: serverTimestamp() };
            await addDoc(collection(db, "students", docId, "fees"), feeData);
            form.reset();
            const now = new Date();
            form['fee-month'].value = now.getMonth() + 1;
            form['fee-year'].value = now.getFullYear();
        };

        const handleUpdateStudent = async (e) => {
            e.preventDefault();
            const form = e.target;
            const docId = form['edit-docId'].value;
            const updatedData = {
                name: form['edit-name'].value.trim(),
                fatherName: form['edit-fatherName'].value.trim(),
                mobile: form['edit-mobile'].value.trim(),
                course: form['edit-course'].value,
            };
            try {
                await updateDoc(doc(db, "students", docId), updatedData);
                closeModal('edit-student-modal');
            } catch (error) {
                showErrorModal("Failed to update student.");
                console.error(error);
            }
        };
        
        // --- Public App Functions ---
        window.app = {
            closeModal,
            populateEditForm: (docId) => {
                const s = allStudents.find(s => s.docId === docId);
                if (!s) return;
                const content = `
                <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">Edit Student Profile</h3>
                    <form id="edit-student-form" class="space-y-4 text-left mt-4">
                        <input type="hidden" id="edit-docId" value="${s.docId}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="edit-studentId" class="block text-sm font-medium">Student ID</label><input type="text" id="edit-studentId" value="${s.studentId || ''}" disabled class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm"></div>
                            <div><label for="edit-name" class="block text-sm font-medium">Full Name</label><input type="text" id="edit-name" value="${s.name || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="edit-fatherName" class="block text-sm font-medium">Father's Name</label><input type="text" id="edit-fatherName" value="${s.fatherName || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                            <div><label for="edit-mobile" class="block text-sm font-medium">Mobile Number <span class="text-red-500">*</span></label><input type="tel" id="edit-mobile" value="${s.mobile || ''}" required pattern="[0-9]{10}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="edit-course" class="block text-sm font-medium">Class/Course</label>
                                <select id="edit-course" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                    <option value="6" ${s.course == '6' ? 'selected' : ''}>6th</option>
                                    <option value="7" ${s.course == '7' ? 'selected' : ''}>7th</option>
                                    <option value="8" ${s.course == '8' ? 'selected' : ''}>8th</option>
                                    <option value="9" ${s.course == '9' ? 'selected' : ''}>9th</option>
                                    <option value="10" ${s.course == '10' ? 'selected' : ''}>10th</option>
                                    <option value="11" ${s.course == '11' ? 'selected' : ''}>11th</option>
                                    <option value="12" ${s.course == '12' ? 'selected' : ''}>12th</option>
                                </select>
                            </div>
                            <div><label for="edit-secretCode" class="block text-sm font-medium">Secret Code</label><input type="text" id="edit-secretCode" value="${s.secretCode || ''}" disabled class="mt-1 block w-full rounded-md bg-gray-100 border-gray-300 shadow-sm"></div>
                        </div>
                        <div class="items-center px-4 py-3 text-right">
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Update</button>
                            <button type="button" onclick="window.app.closeModal('edit-student-modal')" class="px-4 py-2 bg-gray-200 rounded-md ml-2 hover:bg-gray-300">Cancel</button>
                        </div>
                    </form>
                </div>`;
                showModal('edit-student-modal', content);
            },
            deleteStudent: (docId) => {
                const s = allStudents.find(s => s.docId === docId);
                showConfirmationModal('Confirm Deletion', `Delete <strong>${s.name || 'this student'}</strong>?`, `window.app.confirmDelete('${docId}')`);
            },
            confirmDelete: async (docId) => { await deleteDoc(doc(db, "students", docId)); },
            openFeeManager: (docId) => {
                const s = allStudents.find(s => s.docId === docId);
                const now = new Date();
                const content = `<div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-medium">Fee Management for ${s.name}</h3><button onclick="window.app.closeModal('fee-modal')"><i class="fas fa-times"></i></button></div><div class="grid md:grid-cols-2 gap-6"><div><h4 class="font-semibold mb-2">Payment History</h4><div id="fee-history-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div></div><div><h4 class="font-semibold mb-2">Add Payment</h4><form id="add-fee-form" class="space-y-3"><input type="hidden" id="fee-student-doc-id" value="${docId}"><div><label class="text-sm">For Month</label><div class="flex gap-2 mt-1"><select id="fee-month" required class="w-full rounded-md border-gray-300"><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option></select><input type="number" id="fee-year" required class="w-full rounded-md border-gray-300" value="${now.getFullYear()}"></div></div><div><label class="text-sm">Amount Paid (â‚¹)</label><input type="number" id="fee-amount" required class="mt-1 w-full rounded-md border-gray-300"></div><div><label class="text-sm">Payment Method</label><select id="fee-method" class="mt-1 w-full rounded-md border-gray-300"><option>Cash</option><option>Online</option></select></div><button type="submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg">Add Payment</button></form></div></div></div>`;
                showModal('fee-modal', content);
                document.getElementById('fee-month').value = now.getMonth() + 1;
                listenForFees(docId);
            },
            markAttendance: async (studentId, course, status) => {
                const date = document.getElementById('attendance-date').value;
                if (!date) return showErrorModal("Please select a date first.");
                const attendanceDocId = `${date}_${studentId}`;
                await setDoc(doc(db, "attendance", attendanceDocId), { studentId, date, course, status, markedAt: serverTimestamp() });
                loadAttendanceList();
            }
        };

        const listenForFees = (docId) => {
            const feesRef = collection(db, "students", docId, "fees");
            addListener(onSnapshot(query(feesRef, orderBy("paymentDate", "desc")), snapshot => {
                const listEl = document.getElementById('fee-history-list');
                if(!listEl) return;
                listEl.innerHTML = snapshot.empty ? '<p>No payments found.</p>' : snapshot.docs.map(d => {
                    const fee = d.data();
                    return `<div class="p-2 border rounded-md"><div class="flex justify-between"><span>For <strong>${window.app.monthNames[fee.feeMonth]} ${fee.feeYear}</strong></span><strong class="text-green-600">â‚¹${fee.amountPaid}</strong></div><div class="text-xs text-slate-500">${fee.paymentDate.toDate().toLocaleDateString()} - ${fee.paymentMethod}</div></div>`;
                }).join('');
            }));
        };

        const loadAttendanceList = async () => {
            const course = document.getElementById('attendance-course').value;
            const date = document.getElementById('attendance-date').value;
            if (!course || !date) return;
            const listEl = document.getElementById('attendance-student-list');
            const studentsInClass = allStudents.filter(s => s.course === course);
            if (studentsInClass.length === 0) { listEl.innerHTML = '<p class="text-center p-4">No students in this class.</p>'; return; }
            const attendanceQuery = query(collection(db, 'attendance'), where("date", "==", date), where("course", "==", course));
            const attendanceSnapshot = await getDocs(attendanceQuery);
            const attendanceMap = new Map(attendanceSnapshot.docs.map(d => [d.data().studentId, d.data().status]));
            listEl.innerHTML = `<table class="w-full text-sm">...<thead>...</thead><tbody>${studentsInClass.map(s => {
                const status = attendanceMap.get(s.docId) || 'Absent';
                return `<tr class="border-b"><td class="p-2">${s.studentId}</td><td class="p-2">${s.name}</td><td class="p-2 text-center"><button class="px-2 py-1 text-xs rounded ${status === 'Present' ? 'bg-green-500 text-white' : 'bg-gray-200'}" onclick="window.app.markAttendance('${s.docId}','${course}','Present')">P</button> <button class="px-2 py-1 text-xs rounded ${status === 'Absent' ? 'bg-red-500 text-white' : 'bg-gray-200'}" onclick="window.app.markAttendance('${s.docId}','${course}','Absent')">A</button></td></tr>`;
            }).join('')}</tbody></table>`;
        };
        
        document.getElementById('export-csv-btn')?.addEventListener('click', () => {
            const headers = ['StudentID', 'Name', 'FatherName', 'Mobile', 'Course', 'SecretCode', 'JoinedDate'];
            const rows = allStudents.map(s => [s.studentId, s.name, s.fatherName, s.mobile, s.course, s.secretCode, s.createdAt?.toDate().toLocaleDateString() || '']);
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r => r.map(v => `"${v || ''}"`).join(','))].join('\n');
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `students_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        window.app.monthNames = monthNames;
        window.app.closeModal = closeModal;

    </script>
</body>
</html>
